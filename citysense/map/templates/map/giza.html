{% load static %}

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CitySense - Sustainable Urban Planning Platform</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="stylesheet" href="{% static 'css/styles.css' %}" />
  </head>
  <body>
    <div class="container">
      <header>
        <div class="logo">
          <i class="fas fa-globe-americas"></i>
          <h1>CitySense</h1>
        </div>
        <div class="search-container">
          <i class="fas fa-search search-icon"></i>
          <input
            type="text"
            class="search-input"
            placeholder="Search for a city..."
          />
        </div>
        <div class="header-actions">
          <button class="btn btn-outline">Help</button>
          <button class="btn btn-primary">Sign In</button>
        </div>
      </header>

      <aside class="sidebar">
        <div class="city-info">
          <h3 id="sidebar-city-name">New York City</h3>
          <p>
            <i class="fas fa-map-marker-alt"></i>
            <span id="sidebar-city-country">United States</span>
          </p>
          <p>
            <i class="fas fa-users"></i> Population:
            <span id="sidebar-population">8.4 million</span>
          </p>
        </div>

        <div class="sidebar-section">
          <h2><i class="fas fa-temperature-high"></i> Climate Data</h2>
          <div class="data-category">
            <div class="data-item">
              <span class="data-label">Temperature</span>
              <span class="data-value" id="sidebar-temperature">72°F</span>
            </div>
            <div class="data-item">
              <span class="data-label">Rainfall</span>
              <span class="data-value" id="sidebar-rainfall"
                >3.2 in <span class="data-trend trend-up">+12%</span></span
              >
            </div>
            <div class="data-item">
              <span class="data-label">Humidity</span>
              <span class="data-value" id="sidebar-humidity">65%</span>
            </div>
          </div>
        </div>

        <div class="sidebar-section">
          <h2><i class="fas fa-seedling"></i> Environment</h2>
          <div class="data-category">
            <div class="data-item">
              <span class="data-label">Vegetation Index</span>
              <span class="data-value" id="sidebar-vegetation"
                >0.42 <span class="data-trend trend-up">+5%</span></span
              >
            </div>
            <div class="data-item">
              <span class="data-label">Air Quality</span>
              <span class="data-value" id="sidebar-air-quality">Moderate</span>
            </div>
            <div class="data-item">
              <span class="data-label">Soil Type</span>
              <span class="data-value" id="sidebar-soil-type">Loam</span>
            </div>
          </div>
        </div>

        <div class="sidebar-section">
          <h2><i class="fas fa-chart-line"></i> Urban Metrics</h2>
          <div class="data-category">
            <div class="data-item">
              <span class="data-label">Population Growth</span>
              <span class="data-value" id="sidebar-population-growth"
                >1.2% <span class="data-trend trend-up">+0.3%</span></span
              >
            </div>
            <div class="data-item">
              <span class="data-label">Traffic Density</span>
              <span class="data-value" id="sidebar-traffic-density">High</span>
            </div>
            <div class="data-item">
              <span class="data-label">Urban Expansion</span>
              <span class="data-value" id="sidebar-urban-expansion"
                >+2.1% YoY</span
              >
            </div>
          </div>
        </div>
      </aside>

      <main>
        <div id="map"></div>

        <div class="data-overview">
          <div class="metric-card">
            <div class="metric-header">
              <h4>Temperature</h4>
              <div class="metric-icon icon-temperature">
                <i class="fas fa-thermometer-half"></i>
              </div>
            </div>
            <div class="metric-title">Current Average</div>
            <div class="metric-value" id="metric-temperature">72°F</div>
            <div class="metric-change">
              <span class="metric-trend trend-up"
                ><i class="fas fa-arrow-up"></i> 2°</span
              >
              <span>from last month</span>
            </div>
          </div>

          <div class="metric-card">
            <div class="metric-header">
              <h4>Rainfall</h4>
              <div class="metric-icon icon-rainfall">
                <i class="fas fa-cloud-rain"></i>
              </div>
            </div>
            <div class="metric-title">Last 30 Days</div>
            <div class="metric-value" id="metric-rainfall">3.2 in</div>
            <div class="metric-change">
              <span class="metric-trend trend-up"
                ><i class="fas fa-arrow-up"></i> 12%</span
              >
              <span>from average</span>
            </div>
          </div>

          <div class="metric-card">
            <div class="metric-header">
              <h4>Population</h4>
              <div class="metric-icon icon-population">
                <i class="fas fa-users"></i>
              </div>
            </div>
            <div class="metric-title">Metro Area</div>
            <div class="metric-value" id="metric-population">8.4M</div>
            <div class="metric-change">
              <span class="metric-trend trend-up"
                ><i class="fas fa-arrow-up"></i> 1.2%</span
              >
              <span>annual growth</span>
            </div>
          </div>

          <div class="metric-card">
            <div class="metric-header">
              <h4>Air Quality</h4>
              <div class="metric-icon icon-pollution">
                <i class="fas fa-wind"></i>
              </div>
            </div>
            <div class="metric-title">PM2.5 Index</div>
            <div class="metric-value" id="metric-air-quality">42</div>
            <div class="metric-change">
              <span class="metric-trend trend-down"
                ><i class="fas fa-arrow-down"></i> 8%</span
              >
              <span>from last year</span>
            </div>
          </div>
        </div>

        <div class="predictions-section">
          <h2><i class="fas fa-crystal-ball"></i> Future Projections</h2>
          <div class="prediction-cards">
            <!-- Prediction cards would go here in a complete implementation -->
          </div>
          <!-- 2D City Renderer: paste ChatGPT JSON output and render an SVG representation -->
          <div id="city-2d-wrapper" style="margin-top:1rem;">
            <h3>2D City Model</h3>
            <div style="display:flex;gap:0.5rem;margin-bottom:0.5rem;align-items:flex-start;">
              <textarea id="city2d-json" placeholder="Paste ChatGPT JSON (see prompt template)" style="flex:1;height:150px;padding:8px;border-radius:6px;border:1px solid #ddd;font-family:monospace;resize:vertical;"></textarea>
              <div style="display:flex;flex-direction:column;gap:0.5rem;">
                <button id="city2d-render" class="btn btn-primary">Render 2D</button>
                <button id="city2d-sample" class="btn">Load Sample</button>
              </div>
            </div>

            <div id="city-2d" style="width:100%;height:420px;background:#fff;border-radius:8px;box-shadow:var(--card-shadow);overflow:hidden;display:flex;align-items:center;justify-content:center;"></div>

            <details style="margin-top:0.75rem;">
              <summary>ChatGPT prompt template (click to expand)</summary>
              <pre id="city2d-prompt" style="white-space:pre-wrap;padding:12px;background:#f8f9fa;border-radius:6px;margin-top:0.5rem;font-size:0.9rem;">{PROMPT_TEMPLATE}</pre>
            </details>
          </div>
        </div>
      </main>
    </div>

    <div class="chatbot-container">
      <button class="chatbot-btn" id="chatbotToggle">
        <i class="fas fa-robot"></i>
      </button>
      <div class="chatbot-window" id="chatbotWindow">
        <div class="chat-header">
          <h3><i class="fas fa-robot"></i> CitySense Assistant</h3>
          <button class="chat-close" id="chatClose">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="chat-messages" id="chatMessages">
          <div class="message bot">
            Hello! I'm your CitySense assistant. How can I help you with urban
            planning data today?
          </div>
        </div>
        <div class="chat-input">
          <input
            type="text"
            placeholder="Ask about city data..."
            id="chatInput"
          />
          <button id="chatSend"><i class="fas fa-paper-plane"></i></button>
        </div>
      </div>
    </div>
    <!-- Use Leaflet (OpenStreetMap) instead of Google Maps to avoid billing requirement -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    // If Leaflet didn't load (CDN blocked), show a helpful message in the map container.
    (function() {
      function showLeafletMissing() {
        const el = document.getElementById('map');
        if (el) {
          el.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100%;color:#fff;background:#111;border-radius:8px;">Map failed to load. Leaflet library not available.</div>';
        }
      }

      // Give the CDN a moment to load
      setTimeout(() => {
        if (typeof L === 'undefined') {
          console.warn('Leaflet did not load from CDN.');
          showLeafletMissing();
        }
      }, 500);
    })();
  </script>

  <script src="{% static 'js/Map.js'%}"></script>
  </body>
</html>
